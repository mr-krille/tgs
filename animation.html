<!DOCTYPE html>
<html class="no-js">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="css/normalize.min.css">
  <link rel="stylesheet" href="css/animation.css">

  <script src="js/vendor/modernizr-2.6.2.min.js"></script>
</head>
<body>
  <div class="wrapper">
    <div class="playground">
      <span id="hat1" class="hat"></span>
      <span id="hat2" class="hat"></span>
      <span id="hat3" class="hat"></span>
      <span id="ball"></span>
    </div>
  </div>
  <div class="loading">
    <h3>Give it a try.</h3>
    <span>Loading...</span>
  </div>
  <script>
  var app = {
    last: [],
    result: [0, 1, 2],
    matched: 1,
    iterations: 4,
    ball: document.getElementById("ball"),
    hats: [
      document.getElementById("hat1"),
      document.getElementById("hat2"),
      document.getElementById("hat3")
    ],
    animations: {
      "big-right-up": 2,
      "big-left-down": -2,
      "right-up": 1,
      "right-down": 1,
      "left-up": -1,
      "left-down": -1,
    },
    stack: [
      ['big-right-up', null, 'big-left-down'],
      ['right-down', 'left-up', null],
      [null, 'right-down', 'left-up'],
      [null, 'right-up', 'left-down'],
      ['right-up', 'left-down', null]
    ],
    start: function () {
      var moves = app.stack.slice();
      for (var i = moves.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = moves[i];
        moves[i] = moves[j];
        moves[j] = temp;
        if (i === 2) {
          app.pot = j;
          app.hats[j].classList.add('pot');
          app.ball.style.left = j * 50 + '%';
          app.ball.style.display = 'block';
        }
      }
      app.moves = moves;
    },
    move: function () {
      var turn = app.moves.pop();
      var last = app.result.slice();
      app.hats.forEach(function (elm, index) {
        if (app.last && app.last[index]) {
          elm.classList.remove(app.last[index]);
        }
        if (turn[index]) {
          elm.classList.add(turn[index]);
          app.result[index + app.animations[turn[index]]] = last[index];
        }
      });
      app.last = turn;
    },
    show: function (evt) {
      evt.target.classList.add("open");
      //window.setTimeout(function () {
      //  evt.target.classList.remove("open");
      //}, 1000);
      app.hats.map(function (elm) {
        elm.removeEventListener('click', app.handler);
      });
    },
    game: function (evt) {
      if (evt.animationName === 'pull-down') {
        app.ball.style.display = 'none';
        app.hats[app.pot].classList.remove('pot');
        app.move();
      }
      if (app.last.indexOf(evt.animationName) > -1) {
        if (app.matched > 1) {
          app.matched = 1;
          if (app.iterations > 1) {
            app.iterations--;
            app.move();
          } else {
            app.ball.style.left = app.result.indexOf(app.pot) * 50 + '%';
            app.ball.style.display = 'block';
            app.hats.forEach(function (elm) {
              elm.addEventListener('click', app.show);
            });
          }
        } else {
          app.matched++;
        }
      }
    }
  };
  window.addEventListener('load', app.start);
  window.addEventListener('animationend', app.game);
  window.addEventListener('webkitAnimationEnd', app.game);
  </script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.1.min.js"><\/script>')</script>
</body>
</html>
